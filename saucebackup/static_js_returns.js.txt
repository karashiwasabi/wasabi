// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\returns.js

import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';
import { hiraganaToKatakana } from './utils.js';

function formatBalance(balance) {
    if (typeof balance === 'number') {
        return balance.toFixed(2);
    }
    return balance;
}

/**
 * [修正点]
 * 描画ロジックを方針書に沿って1段階プロセスに変更。
 * HTML文字列を一度で完全に組み立ててからDOMにセットします。
 */
function renderReturnCandidates(data, container) {
    if (!data || data.length === 0) {
        container.innerHTML = "<p>返品可能な品目はありませんでした。</p>";
        return;
    }

    // ▼▼▼【ここからが修正箇所です】▼▼▼
    // 1回のループで、納品履歴テーブルまで含んだ完全なHTML文字列を生成する
    let html = data.map((yjGroup, yjIndex) => {
        const yjHeader = `
            <div class="agg-yj-header" style="background-color: #0d6efd; color: white;">
                <span>YJ: ${yjGroup.yjCode}</span>
                <span class="product-name">${yjGroup.productName}</span>
            </div>
        `;
        
        const packagesHtml = yjGroup.packageLedgers.map((pkg, pkgIndex) => {
            const surplus = pkg.effectiveEndingBalance - pkg.reorderPoint;
            let pkgHeader = `
                <div class="agg-pkg-header" style="border-left: 5px solid #0d6efd;">
                    <span>包装: ${pkg.packageKey}</span>
                    <span class="balance-info">
                        在庫: ${formatBalance(pkg.effectiveEndingBalance)} | 
                        発注点: ${formatBalance(pkg.reorderPoint)} | 
                        <strong style="color: #0d6efd;">余剰数(目安): ${formatBalance(surplus)}</strong>
                    </span>
                </div>
            `;

            // 納品履歴が存在する場合、その場でテーブルのHTMLを生成する
            if (pkg.deliveryHistory && pkg.deliveryHistory.length > 0) {
                const tableId = `delivery-history-${yjIndex}-${pkgIndex}`;
                
                // テーブルの枠と中身のHTML文字列をそれぞれ取得
                const tableShell = createUploadTableHTML(tableId);
                const tableBodyContent = renderUploadTableRows(pkg.deliveryHistory);
                
                // 文字列を結合して完全なテーブルHTMLを生成
                const fullTableHtml = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);
                
                pkgHeader += `<div id="${tableId}-container" style="padding: 0 10px 10px 10px;">${fullTableHtml}</div>`;
            }
            return pkgHeader;
        }).join('');

        return yjHeader + packagesHtml;
    }).join('');

    // 完成したHTMLを一度だけDOMに書き込む
    container.innerHTML = html;

    // 以前ここにあった、DOM描画後に納品履歴を埋め込むための2番目のループは不要になったため削除
    // ▲▲▲【修正ここまで】▲▲▲
}

export function initReturnsView() {
    const view = document.getElementById('returns-view');
    if (!view) return;

    const runBtn = document.getElementById('run-returns-list-btn');
    const outputContainer = document.getElementById('returns-list-output-container');
    const startDateInput = document.getElementById('ret-startDate');
    const endDateInput = document.getElementById('ret-endDate');
    const kanaNameInput = document.getElementById('ret-kanaName');
    const dosageFormInput = document.getElementById('ret-dosageForm');
    const coefficientInput = document.getElementById('ret-coefficient');
    const printBtn = document.getElementById('print-returns-list-btn');

    // ▼▼▼ [ここから修正] ▼▼▼
    const today = new Date();
    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1); // 3ヶ月前の1日
    endDateInput.value = new Date().toISOString().slice(0, 10);
    startDateInput.value = threeMonthsAgo.toISOString().slice(0, 10);
    // ▲▲▲ [修正ここまで] ▲▲▲

    runBtn.addEventListener('click', async () => {
        window.showLoading();
        const params = new URLSearchParams({
            startDate: startDateInput.value.replace(/-/g, ''),
            endDate: endDateInput.value.replace(/-/g, ''),
            kanaName: hiraganaToKatakana(kanaNameInput.value),
            dosageForm: dosageFormInput.value,
            coefficient: coefficientInput.value,
        });

        try {
            const res = await fetch(`/api/returns/candidates?${params.toString()}`);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || 'List generation failed');
            }
            const data = await res.json();
            renderReturnCandidates(data, outputContainer);
        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
        } finally {
            window.hideLoading();
        }
    });

    printBtn.addEventListener('click', () => {
        view.classList.add('print-this-view');
        window.print();
    });

    window.addEventListener('afterprint', () => {
        view.classList.remove('print-this-view');
    });
}
